from math import log

def sign(x):
    if x < 0:
        return -1
    return 1

DecompressTable = [
-32768, 
-31373, -30037, -28758, -27534, -26361, -25238, -24162, -23132, 
-22146, -21202, -20297, -19431, -18602, -17808, -17047, -16319, 
-15622, -14954, -14315, -13702, -13116, -12554, -12017, -11502, 
-11009, -10536, -10084, -9651, -9237, -8839, -8459, -8095, 
-7746, -7413, -7093, -6787, -6493, -6213, -5944, -5686, 
-5440, -5204, -4978, -4761, -4554, -4355, -4165, -3983, 
-3809, -3642, -3482, -3329, -3182, -3042, -2907, -2779, 
-2655, -2537, -2424, -2316, -2212, -2113, -2018, -1927, 
-1840, -1756, -1676, -1600, -1527, -1456, -1389, -1325, 
-1263, -1204, -1148, -1094, -1042, -992, -945, -899, 
-855, -814, -774, -735, -699, -664, -630, -598, 
-567, -538, -509, -482, -456, -432, -408, -385, 
-363, -342, -322, -303, -285, -267, -251, -234, 
-219, -204, -190, -177, -164, -151, -139, -128, 
-117, -107, -97, -87, -78, -69, -61, -53, 
-45, -38, -31, -24, -17, -11, -5, 0, 
5, 11, 17, 24, 31, 38, 45, 53, 
61, 69, 78, 87, 97, 107, 117, 128, 
139, 151, 164, 177, 190, 204, 219, 234, 
251, 267, 285, 303, 322, 342, 363, 385, 
408, 432, 456, 482, 509, 538, 567, 598, 
630, 664, 699, 735, 774, 814, 855, 899, 
945, 992, 1042, 1094, 1148, 1204, 1263, 1325, 
1389, 1456, 1527, 1600, 1676, 1756, 1840, 1927, 
2018, 2113, 2212, 2316, 2424, 2537, 2655, 2779, 
2907, 3042, 3182, 3329, 3482, 3642, 3809, 3983, 
4165, 4355, 4554, 4761, 4978, 5204, 5440, 5686, 
5944, 6213, 6493, 6787, 7093, 7413, 7746, 8095, 
8459, 8839, 9237, 9651, 10084, 10536, 11009, 11502, 
12017, 12554, 13116, 13702, 14315, 14954, 15622, 16319, 
17047, 17808, 18602, 19431, 20297, 21202, 22146, 23132, 
24162, 25238, 26361, 27534, 28758, 30037, 31373, #32768 
]

CompressTable =[
    0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,
    4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
    5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,
    5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7 ]

_u = 255
_log_u_1 = log(_u+1)
_cClip = 32635
_cBias = 0x84
def encode(int16) -> int:
    """Returns compressed 8 bit value from 16 bit value"""
    neg = sign(int16) == -1
    if neg:
        int16 = (-1*int16)&0xffff #< If negative, make positive
    if (int16 > _cClip):
        int16 = _cClip;
    int16 = (int16 + _cBias)&0xffff
    exponent = CompressTable[ (int16>>7)&0xff ]
    mantissa = (int16 >> (exponent+3))&0xf #< 4 bit mantisa
    int8 = (exponent<<4)|mantissa
    if neg:
        return -int8
    return int8

def decode(int8) -> int:
    """Returns the decompressed 16 bit value from 8 bit value"""
    return DecompressTable[int8 +0x80]

def encodeSlow(int16) -> int:
    """"""
    x = int16/(2**15) #< Normalizing input to +/1.0 values
    return int(127*sign(x)*log(1 +_u*abs(x))/_log_u_1)

def decodeSlow(int8) -> int:
    """"""
    y = int8/(2**7) #< Normalizing input to +/1.0 values
    return (2**15)*sign(y)*((1+_u)**abs(y) -1)/_u

if __name__ == "__main__":
    for i in range(-200,201):
        x = int(i*(2**15)/200)
        encF = encode(x)
        decF = decode(encF)
        encS = encodeSlow(x)
        decS = decodeSlow(encS)
        print("val %d, encodeF %d, decodeF %d"%(x, encF, decF))
        print("val %d, encodeS %d, decodeS %d"%(x, encS, decS))
